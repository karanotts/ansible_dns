---
- name: Create DNSSEC keys dirs
  file:
    path: "{{ bind_zone_dir }}/keys/{{ item.name }}"
    state: directory
    owner: "{{ bind_owner }}"
    group: "{{ bind_group }}"
    mode: 0755
  with_list: "{{ bind_domain_zones }}"

- name: Create DNSSEC keys
  command: "dnssec-keygen -r /dev/urandom -a HMAC-MD5 -b 512 -n HOST {{ item.name }}"
  args:
    chdir: "{{ bind_zone_dir }}/keys/{{ item.name }}"
  with_list: "{{ bind_domain_zones }}"

- name: Get DNSSEC key value
  command: "grep Key /etc/bind/zones/keys/{{ item.name }}/K{{ item.name }}.*.private | awk '{print $2}'"
  register: command_result
  with_list: "{{ bind_domain_zones }}"
- debug: var=command_result.stdout_lines

- name: Write key secret to conf.options.keys
  template:
    src: "named.conf.options.keys.j2"
    dest: "{{ bind_dir }}/named.conf.options.keys.{{ item.item.name }}"
    owner: "{{ bind_owner }}"
    group: "{{ bind_group }}"
    mode: 0755
  with_items: "{{ bind_dns_key_secret.results }}"
